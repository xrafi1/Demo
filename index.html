<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 10; background-color: #e5e7eb; }
        .leaflet-control-attribution, .leaflet-control-zoom { display: none; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .emoji-icon {
            font-size: 32px;
            text-align: center;
            line-height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="map"></div>

    <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-md">
        <div class="bg-white rounded-xl shadow-2xl p-4 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Live Bus Tracker</h1>
                    <p class="text-xs text-gray-500">Bus ID: <span class="font-medium">BUS-42</span></p>
                </div>
                <div class="text-right">
                    <div class="flex items-center justify-end space-x-2">
                        <span id="status-indicator" class="h-3 w-3 rounded-full bg-gray-400"></span>
                        <span id="status-text" class="text-sm font-semibold text-gray-600">Initializing...</span>
                    </div>
                    <p id="last-update" class="text-xs text-gray-400 mt-1">Awaiting signal...</p>
                </div>
            </div>
            <div class="flex items-center space-x-2 mt-3 pt-3 border-t">
                 <button id="recenter-school-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-2 px-3 rounded-lg transition shadow">Center on School</button>
                 <button id="find-bus-btn" class="w-full bg-gray-300 text-gray-500 text-xs font-bold py-2 px-3 rounded-lg transition shadow cursor-not-allowed" disabled>Find Bus</button>
            </div>
        </div>
    </div>
    
    <div id="error-overlay" class="hidden absolute inset-0 z-30 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 border-4 border-red-300 max-w-sm text-center">
            <h2 class="text-xl font-bold text-red-600 mb-2">Connection Failed</h2>
            <p id="error-message" class="text-gray-700">The app could not connect to the backend.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const schoolConfig = {
            name: "St. Albert's School, Bongaigaon",
            location: { lat: 26.513118, lng: 90.961866 }
        };

        const busId = "BUS-42";
        let db, map, busMarker, schoolMarker;
        
        const ui = {
            statusText: document.getElementById('status-text'),
            statusIndicator: document.getElementById('status-indicator'),
            lastUpdate: document.getElementById('last-update'),
            errorOverlay: document.getElementById('error-overlay'),
            errorMessage: document.getElementById('error-message'),
            findBusBtn: document.getElementById('find-bus-btn'),
            recenterSchoolBtn: document.getElementById('recenter-school-btn'),
        };

        async function initApp() {
            try {
                // Use environment variables for Firebase config for security
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                 if (!firebaseConfig) {
                    throw new Error("Firebase configuration is missing.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase Authenticated.");
                initMapView();
                listenForBusLocation();
                setupControls();
            } catch (error) {
                console.error("Firebase Init Failed!", error);
                ui.statusText.textContent = 'Connection Failed';
                ui.errorMessage.textContent = `Error: ${error.message}. Please check the console.`;
                ui.errorOverlay.classList.remove('hidden');
            }
        }

        function initMapView() {
            if (map) return;
            map = L.map('map').setView([schoolConfig.location.lat, schoolConfig.location.lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            const schoolIcon = L.divIcon({ html: 'üè´', className: 'emoji-icon', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40] });
            schoolMarker = L.marker([schoolConfig.location.lat, schoolConfig.location.lng], { icon: schoolIcon })
                .addTo(map)
                .bindPopup(`<b>${schoolConfig.name}</b>`)
                .openPopup();

            ui.statusText.textContent = 'Listening...';
        }

        function listenForBusLocation() {
            const busRef = doc(db, "buses", busId);
            onSnapshot(busRef, (doc) => {
                updateUIWithBusData(doc.exists() ? doc.data() : null);
            });
        }
        
        function updateUIWithBusData(data) {
            const busIsOnline = data && data.status === 'en-route' && data.lat && data.lng;

            if (busIsOnline) {
                ui.statusText.textContent = 'En Route';
                ui.statusIndicator.className = 'h-3 w-3 rounded-full bg-green-500 pulse';
                ui.lastUpdate.textContent = `Updated: ${data.lastUpdate.toDate().toLocaleTimeString()}`;
                
                ui.findBusBtn.disabled = false;
                ui.findBusBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                ui.findBusBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-black');

                const busPosition = [data.lat, data.lng];
                const busIcon = L.divIcon({ html: 'üöå', className: 'emoji-icon', iconSize: [40, 40], iconAnchor: [20, 20] });

                if (!busMarker) {
                    busMarker = L.marker(busPosition, { icon: busIcon }).addTo(map);
                    map.flyTo(busPosition, 16, { duration: 2 });
                } else {
                    busMarker.setLatLng(busPosition);
                    if (map.getBounds().contains(busMarker.getLatLng())) {
                        map.panTo(busPosition, { animate: true, duration: 1 });
                    }
                }
            } else {
                ui.statusText.textContent = 'Offline';
                ui.statusIndicator.className = 'h-3 w-3 rounded-full bg-red-500';
                ui.lastUpdate.textContent = 'Bus is currently offline.';
                
                ui.findBusBtn.disabled = true;
                ui.findBusBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                ui.findBusBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-black');

                // If bus goes offline, remove the marker from the map
                if (busMarker) {
                    busMarker.remove();
                    busMarker = null;
                }
            }
        }
        
        function setupControls() {
            ui.findBusBtn.addEventListener('click', () => {
                if (busMarker) map.flyTo(busMarker.getLatLng(), 16, { duration: 1.5 });
            });
            ui.recenterSchoolBtn.addEventListener('click', () => {
                if (schoolMarker) map.flyTo(schoolMarker.getLatLng(), 14, { duration: 1.5 });
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

